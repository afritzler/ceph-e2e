name: Setup Minikube and Ceph on macOS

on:
  push:
    branches:
      - main

jobs:
  setup-minikube:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Homebrew
        run: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      - name: Install Minikube
        run: brew install minikube

      - name: Start Minikube
        run: minikube start --disk-size=40g --extra-disks 1 --driver qemu

      - name: Install Helm
        run: brew install helm

      - name: Add Rook repository
        run: helm repo add rook-release https://charts.rook.io/release

      - name: Install Rook Operator
        run: helm install --create-namespace --namespace rook-ceph rook-ceph rook-release/rook-ceph \
          --set csi.enableRbdDriver=false \
          --set csi.enableCephfsDriver=false \
          --set csi.enableCephfsSnapshotter=false \
          --set csi.enableRBDSnapshotter=false

      - name: Apply CephCluster configuration
        run: |
          cat <<EOF | kubectl apply -f -
          kind: ConfigMap
          apiVersion: v1
          metadata:
            name: rook-config-override
            namespace: rook-ceph
          data:
            config: |
              [global]
              osd_pool_default_size = 1
              mon_warn_on_pool_no_redundancy = false
              bdev_flock_retry = 20
              bluefs_buffered_io = false
              mon_data_avail_warn = 10
          ---
          apiVersion: ceph.rook.io/v1
          kind: CephCluster
          metadata:
            name: my-cluster
            namespace: rook-ceph
          spec:
            dataDirHostPath: /var/lib/rook
            cephVersion:
              image: quay.io/ceph/ceph:v18
              allowUnsupported: true
            mon:
              count: 1
              allowMultiplePerNode: true
            mgr:
              count: 1
              allowMultiplePerNode: true
            dashboard:
              enabled: true
            crashCollector:
              disable: true
            storage:
              useAllNodes: true
              useAllDevices: true
              #deviceFilter:
            monitoring:
              enabled: false
            healthCheck:
              daemonHealth:
                mon:
                  interval: 45s
                  timeout: 600s
            priorityClassNames:
              all: system-node-critical
              mgr: system-cluster-critical
            disruptionManagement:
              managePodBudgets: true
          ---
          apiVersion: ceph.rook.io/v1
          kind: CephBlockPool
          metadata:
            name: builtin-mgr
            namespace: rook-ceph
          spec:
            name: .mgr
            replicated:
              size: 1
              requireSafeReplicaSize: false
          EOF

      - name: Wait for CephCluster to be healthy or warning
        run: |
          echo "Waiting for CephCluster to be healthy or in warning status..."
          while true; do
          kubectl -n rook-ceph get pods 
          HEALTH_STATUS=$(kubectl -n rook-ceph get cephcluster -o jsonpath='{.items[0].status.ceph.health}')
          echo "CephCluster health status: $HEALTH_STATUS"
          if [[ "$HEALTH_STATUS" == "HEALTH_OK" || "$HEALTH_STATUS" == "HEALTH_WARN" ]]; then
           break
          fi
          sleep 5
          done
          echo "CephCluster is in acceptable state!"

      - name: Your subsequent steps
        run: echo "You can run other steps that use Minikube and Ceph here."
