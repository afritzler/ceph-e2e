name: Run e2e tests

on:
  pull_request:
    types: [labeled, synchronize, reopened]
    paths-ignore:
      - 'docs/**'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'e2e-tests')

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Update system and install required packages
        run: |
          sudo pip3 install git+https://github.com/ceph/ceph-deploy.git

      - name: Create loopback device for OSD
        run: |
          sudo dd if=/dev/zero of=/tmp/loopback.img bs=1M count=5120
          LOOP_DEVICE=$(sudo losetup --find --show /tmp/loopback.img)
          echo "LOOP_DEVICE=${LOOP_DEVICE}" >> $GITHUB_ENV

      - name: Setup Ceph Cluster
        run: |
          mkdir ~/my-ceph-cluster
          cd ~/my-ceph-cluster
          ceph-deploy new $(hostname)
          
          echo "osd pool default size = 1" >> ceph.conf
          echo "osd crush chooseleaf type = 0" >> ceph.conf
          echo "osd pool default pg num = 128" >> ceph.conf
          echo "osd pool default pgp num = 128" >> ceph.conf
          
          ceph-deploy install $(hostname)
          ceph-deploy mon create-initial
          ceph-deploy osd create $(hostname):${LOOP_DEVICE}

      - name: Create a Ceph Block Pool and Client Secrets
        run: |
          # Create a block pool
          POOL_NAME=mypool
          ceph osd pool create $POOL_NAME 128 128

          # Define client name and path to keyring
          CLIENT_NAME=client.myuser
          KEYRING_PATH=client.myuser.keyring

          # Create or get a client key
          ceph auth get-or-create $CLIENT_NAME mon 'allow r' osd "allow rwx pool=$POOL_NAME" > $KEYRING_PATH

          # Extract the key and write to GITHUB_ENV
          CLIENT_KEY=$(ceph auth get-key $CLIENT_NAME)
          MONITOR_INFO=$(ceph mon dump | grep '^0' | awk '{print $3}')

          echo "CEPH_POOL_NAME=$POOL_NAME" >> $GITHUB_ENV
          echo "CEPH_CLIENT_NAME=$CLIENT_NAME" >> $GITHUB_ENV
          echo "CEPH_CLIENT_SECRET=$CLIENT_KEY" >> $GITHUB_ENV
          echo "CEPH_KEYRING_PATH=$(pwd)/$KEYRING_PATH" >> $GITHUB_ENV
          echo "CEPH_MONITORS=$MONITOR_INFO" >> $GITHUB_ENV

      - name: Check Ceph Status and Environment Variables
        run: |
          ceph -s
          echo "Pool Name: $CEPH_POOL_NAME"
          echo "Client Name: $CEPH_CLIENT_NAME"
          echo "Client Secret: $CEPH_CLIENT_SECRET"
          echo "Keyring Path: $CEPH_KEYRING_PATH"
          echo "Monitors: $CEPH_MONITORS"
